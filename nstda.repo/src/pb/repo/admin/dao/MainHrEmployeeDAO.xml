<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pb.repo.admin.dao.MainHrEmployeeDAO">
    <resultMap id="result" type="mainHrEmployeeModel">
        <result property="id" column="id"/>
        <result property="employeeCode" column="employee_code"/>
        <result property="title" column="title"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="gender" column="gender"/>
        <result property="mobilePhone" column="mobile_phone"/>
        <result property="workEmail" column="work_email"/>
        <result property="workPhone" column="work_phone"/>
        <result property="workLocation" column="work_location"/>
        <result property="orgId" column="org_id"/>
        <result property="costcenterId" column="costcenter_id"/>
        <result property="sectionId" column="section_id"/>
        <result property="deapartmentId" column="department_id"/>
        <result property="image" column="image"/>
        <result property="imageSmall" column="image_small"/>
        <result property="nameRelated" column="name_related"/>
        <result property="positionId" column="position_id"/>
        <result property="positionManagementId" column="position_management_id"/>
        <result property="isManagement" column="is_management"/>
        <result property="totalRowCount" column="totalRowCount"/>
        
    </resultMap>

	<select id="list" resultMap="result">
		select * from pb2_ext_hr_employee order by first_name,last_name
	</select>
	
	<select id="listBySection" resultType="map" parameterType="map">
		select	e.employee_code, first_name,last_name ,po.name "position",s.name utype, e.position_id
		from	pb2_ext_hr_employee e, pb2_ext_res_org o ,pb2_ext_res_section s,pb2_ext_hr_position po
		where	e.org_id = o.id
		and	e.section_id = s.id
		and	e.position_id = po.id
		and	e.section_id = #{code}
		<if test="terms != null">
			<foreach item="item" index="index" collection="terms" open="AND (" separator=" AND " close=")">
	    			concat(e.employee_code, ' ', first_name, ' ', last_name, ' ', po.name, ' ', s.name, ' ', first_name_th, ' ', last_name_th) ILIKE '%'||#{item}||'%'
	   		</foreach>
   		</if>  		
		order by	first_name,last_name
	</select>

	<select id="listByProject" resultType="map" parameterType="map">
		select	e.employee_code, e.first_name, e.last_name, po.name "position" , concat(p.name,' - ',p.description) utype, e.position_id 
		from	pb2_ext_res_project_member pm, pb2_ext_hr_employee e ,pb2_ext_hr_position po, pb2_ext_res_project p
		where	e.id = pm.employee_id
		and 	e.position_id = po.id
		and	pm.project_id = p.id
		and	pm.project_id = #{code}
		<if test="terms != null">
			<foreach item="item" index="index" collection="terms" open="AND (" separator=" AND " close=")">
	    			concat(e.employee_code, ' ', e.first_name, ' ', e.last_name, ' ', po.name, ' ', p.name, ' ',p.description) ILIKE '%'||#{item}||'%'
	   		</foreach>
   		</if>  		
		order by 	first_name,last_name
	</select>
	
	<select id="listForSearch" resultType="map" parameterType="map">
		select * from
		(
			select e.employee_code, e.first_name,e.last_name ,po.name "position",s.description utype, e.position_id
			from pb2_ext_hr_employee${lang} e, pb2_ext_res_org o ,pb2_ext_res_section s,pb2_ext_hr_position po
			where e.org_id = o.id
			and e.section_id = s.id
			and e.position_id = po.id
		union
			select e.employee_code, e.first_name, e.last_name, po.name "position" , concat(p.name,' - ',p.description) utype, e.position_id
			from pb2_ext_res_project_member pm, pb2_ext_hr_employee${lang} e ,pb2_ext_hr_position po, pb2_ext_res_project p
			where e.id = pm.employee_id
			and e.position_id = po.id
			and pm.project_id = p.id
		) a
		WHERE 1=1
		<if test="terms != null">
			<foreach item="item" index="index" collection="terms" open="AND (" separator=" AND " close=")">
	    			concat(employee_code, ' ', first_name, ' ', last_name, ' ', position, ' ', utype) ILIKE '%'||#{item}||'%'
	   		</foreach>
		</if>  		
		order by employee_code,first_name,last_name,utype,"position"
	</select>
	
	<select id="count"  resultType="long">
        select
		    count(1)
		from
		    pb2_ext_hr_employee
    </select>
    
    <select id="get" parameterType="string" resultMap="result">
        SELECT
		    *
		FROM
		    pb2_ext_hr_employee
		WHERE lpad(employee_code, 6 ,'0')=lpad(#{code}, 6 ,'0')
    </select>
    
    <select id="getWithDtl" parameterType="map" resultType="map" >
		select
			e.id,
			e.name_related,
			lpad(e.employee_code, 6 ,'0') as employee_code,
			e.first_name,
			e.last_name,
			e.work_phone,
			e.mobile_phone,
			o.description org_desc,
			o.name org_name, 
			s.id section_id,
			s.description section_desc,
			s.name section_name,
			d.name div_name,
			e.section_id,
			e.org_id
		from pb2_ext_hr_employee${lang} e left join pb2_ext_res_org o on e.org_id = o.id
		left join pb2_ext_res_section s on e.section_id = s.id
		left join pb2_ext_res_division d on d.id = s.division_id
		where lpad(e.employee_code, 6 ,'0')=lpad(#{code}, 6 ,'0')    
	</select>    
	
</mapper>
