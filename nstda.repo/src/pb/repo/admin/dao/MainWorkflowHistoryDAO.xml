<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pb.repo.admin.dao.MainWorkflowHistoryDAO">
    <resultMap id="result" type="mainWorkflowHistoryModel">
        <result property="id" column="id"/>
        <result property="masterId" column="master_id"/>
        <result property="time" column="time"/>
        <result property="by" column="by"/>
        <result property="action" column="action"/>
        <result property="task" column="task"/>
        <result property="comment" column="comment"/>
        <result property="level" column="level"/>
    </resultMap>
    
    <insert
		id="add"
		parameterType="mainWorkflowHistoryModel"
		flushCache="true"
		statementType="PREPARED"
		keyProperty="id"
		useGeneratedKeys="true"
		>
	    INSERT INTO pb2_main_workflow_history(
	    	master_id,time,by,action,task,comment,level
	    ) VALUES (
	    	#{masterId},#{time},#{by},#{action},#{task},#{comment},#{level}
    	)
		
	</insert>
	
	<select id="listHistory" parameterType="map" resultMap="result" >
    
        select pb2_main_workflow_history.*, COUNT(*) OVER() totalRowCount from pb2_main_workflow_history ,pb2_main_workflow 

		where pb2_main_workflow.id = pb2_main_workflow_history.master_id and pb2_main_workflow.master_id = #{masterId}
		
		<if test="orderDesc != null">
		ORDER BY pb2_main_workflow_history.id DESC
		</if>
    </select>
    
    <select id="listByMasterId" parameterType="map" resultMap="result">
        SELECT *, COUNT(*) OVER() totalRowCount
        FROM pb2_main_workflow_history
        WHERE master_id IN
		<foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
    			#{item}
   		</foreach>        
        ORDER BY id
    </select>

    <delete id="deleteByMasterId"
    		parameterType="string"
			flushCache="true"
			statementType="PREPARED"
			>
   		DELETE FROM pb2_main_workflow_history 
   		WHERE master_id IN (SELECT id from pb2_main_workflow where master_id=#{masterId})
	</delete>    
	
	<update id="update" 
        parameterType="mainWorkflowHistoryModel"
		flushCache="true">
     UPDATE pb2_main_workflow_history 
     SET action=#{action}
     WHERE id=#{id}
    </update>
    
</mapper>

